Manual de Auditoría Técnica: Meta Conversion Tracking (Arquitectura Híbrida)
Versión: 1.0 Rol: Senior Technical Solution Consultant Alcance: Validación de integridad de datos, deduplicación y calidad de emparejamiento (EMQ) para eventos Web.
Este documento establece los estándares técnicos para la implementación manual de los eventos: PageView, Schedule, ViewContent, Contact, Search y AddToWishlist.

--------------------------------------------------------------------------------
1. Fundamentos de Arquitectura y Match Quality
Para maximizar la Calidad de Coincidencia de Eventos (EMQ) y asegurar la atribución correcta, ambos canales (Browser y Server) deben enviar parámetros de usuario enriquecidos.
Estándar de Datos de Usuario (user_data)
Tanto el Píxel (vía advanced matching) como la API de Conversiones (en el objeto user_data) deben incluir los siguientes parámetros para lograr una puntuación EMQ > 6.0 (Good/Great).
• Hashing Obligatorio: Todos los datos de identificación personal (PII) deben normalizarse y hashearse utilizando SHA-256 antes del envío (excepto IP, User Agent, fbp, fbc, external_id).
• Parámetros Prioritarios:
    1. em (Email): Minúsculas, sin espacios.
    2. ph (Teléfono): Solo dígitos, incluyendo código de país.
    3. fbp (Browser ID): Valor de la cookie _fbp. Crítico para la continuidad de la sesión.
    4. fbc (Click ID): Valor de la cookie _fbc o parámetro fbclid si proviene de un anuncio.
    5. client_ip_address y client_user_agent: Obligatorios para eventos Web en CAPI.
    6. external_id: ID único de CRM o Login del usuario.

--------------------------------------------------------------------------------
2. Protocolo de Deduplicación
La deduplicación es el mecanismo crítico para evitar el conteo doble de conversiones en una configuración redundante. Meta descarta eventos duplicados si se cumplen las siguientes condiciones técnicas:
1. Coincidencia de event_id: El eventID enviado en el navegador debe ser idéntico (string única) al event_id enviado en el payload del servidor.
2. Coincidencia de event_name: Los nombres deben ser idénticos (ej. "Purchase" en ambos, no "purchase" vs "Purchase").
3. Ventana de Tiempo: Los eventos deben recibirse dentro de un lapso de 48 horas entre sí.
Regla de Auditoría: Si un evento llega por ambos canales con el mismo ID, Meta prioriza generalmente el evento del navegador si llegan con menos de 5 minutos de diferencia, utilizando el evento del servidor para rellenar datos faltantes o como respaldo si el navegador falla (ej. AdBlockers).

--------------------------------------------------------------------------------
3. Auditoría Detallada por Evento
3.1 Evento: PageView (Visita a Página)
Evento base para establecer tráfico y audiencias generales.
• Trigger: Carga inicial del DOM en cada página del sitio.
A. Capa de Navegador (Pixel Manual)
• Script:
• Nota: El eventID es el cuarto parámetro.
B. Capa de Servidor (CAPI Payload)
• Estructura JSON:
• Referencia de parámetros:.

--------------------------------------------------------------------------------
3.2 Evento: Schedule (Programar)
Reserva de una cita o visita a una ubicación física.
• Trigger: Confirmación exitosa de la reserva de cita.
A. Capa de Navegador (Pixel Manual)
• Script:
• Referencia:.
B. Capa de Servidor (CAPI Payload)
• Estructura JSON:
• Referencia:.

--------------------------------------------------------------------------------
3.3 Evento: ViewContent (Ver Contenido)
Visita a una página de detalle de producto o landing page específica. Crítico para retargeting dinámico.
• Trigger: Carga de la página de detalle del producto (PDP).
A. Capa de Navegador (Pixel Manual)
• Script:
• Referencia:.
B. Capa de Servidor (CAPI Payload)
• Estructura JSON:
• Referencia:.

--------------------------------------------------------------------------------
3.4 Evento: Contact (Contactar)
Inicio de contacto vía teléfono, SMS, email o chat.
• Trigger: Clic en botón de "WhatsApp", "Enviar Email" o envío de formulario de contacto general.
A. Capa de Navegador (Pixel Manual)
• Script:
• Referencia:.
B. Capa de Servidor (CAPI Payload)
• Estructura JSON:
• Referencia:.

--------------------------------------------------------------------------------
3.5 Evento: Search (Buscar)
Realización de una búsqueda en el sitio web.
• Trigger: Al ejecutar una búsqueda interna (carga de página de resultados).
A. Capa de Navegador (Pixel Manual)
• Script:
• Referencia:.
B. Capa de Servidor (CAPI Payload)
• Estructura JSON:
• Referencia:.

--------------------------------------------------------------------------------
3.6 Evento: AddToWishlist (Agregar a lista de deseos)
Guardar un producto en una lista de deseos.
• Trigger: Clic en el botón/icono de "Favoritos" o "Wishlist".
A. Capa de Navegador (Pixel Manual)
• Script:
• Referencia:.
B. Capa de Servidor (CAPI Payload)
• Estructura JSON:
• Referencia:.

--------------------------------------------------------------------------------
4. Prueba de Fuego: Validación con "Test Events Tool"
La herramienta "Probar eventos" en el Administrador de Eventos es el método definitivo para verificar que el servidor está procesando y deduplicando correctamente.
Procedimiento de Prueba
1. Vaya al Administrador de Eventos > Pestaña Probar eventos (Test Events).
2. Genere un código de prueba en la sección "Probar eventos del servidor".
3. Server: Incluya este código en el parámetro test_event_code dentro de su payload JSON del servidor.
4. Browser: Abra su sitio web e interactúe para disparar los eventos del Píxel.
5. Verificación: Ambos eventos (Browser y Server) deben aparecer en la consola. El estado final debe ser "Deduplicated" (Deduplicado).
Diagnóstico de Problemas y Tratamiento
Problema Observado
Causa Probable
Opción de Tratamiento (Solución)
Eventos Duplicados (No se unifican)
El event_id es diferente o el event_name no coincide exactamente (distinción mayúsculas/minúsculas).
Auditar que el script del navegador y el payload del servidor generen y usen la misma variable para el ID. Verificar ortografía (ej: "Schedule" vs "schedule").
Evento de Servidor no aparece
Falta el Token de Acceso, error en la petición HTTP (4xx/5xx) o falta el test_event_code.
Verificar que el servidor reciba un código HTTP 200 de Meta. Asegurar que el test_event_code está activo y es correcto. Verificar permisos del Token.
"Invalid Contents Parameter"
Formato JSON incorrecto en contents.
Asegurar que contents sea un array de objetos (ej. [{'id': '...', 'quantity': 1}]) y no una cadena de texto plana o un objeto único fuera de un array.
Baja Calidad de Coincidencia (EMQ < 4)
Faltan datos de usuario (user_data) o no están hasheados.
Incluir fbp y fbc extraídos de las cookies. Normalizar y hashear emails/teléfonos. Enviar IP y User Agent del cliente.
Deduplicación fallida por tiempo
Retraso excesivo (>48h) o marca de tiempo incorrecta.
Verificar que event_time esté en formato Unix (segundos) y zona horaria GMT. Asegurar envío en tiempo real.
Nota Final: Recuerde eliminar el parámetro test_event_code de su configuración de producción una vez finalizada la auditoría para evitar ensuciar los datos